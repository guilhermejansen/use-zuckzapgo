# üìã Changelog

Todas as mudan√ßas importantes neste projeto ser√£o documentadas neste arquivo.

O formato √© baseado em [Keep a Changelog](https://keepachangelog.com/pt-BR/1.0.0/),
e este projeto adere ao [Semantic Versioning](https://semver.org/lang/pt-BR/).

## [v1.2.4] - 2025-09-08

### ‚ú® Destaques da vers√£o
- BaseURL em todos os eventos (Webhook + RabbitMQ) sem poluir o payload do usu√°rio. Cabe√ßalhos e campos dedicados garantem rastreabilidade/end-to-end.
- S3 Global com modo ‚ÄúOwner enforced‚Äù: novo `GLOBAL_S3_DISABLE_ACL` (default: true). Sem√¢ntica clara de entrega (`base64`, `url` ou `both`).
- Chamadas: rejei√ß√£o autom√°tica com mensagem/tipo globais configur√°veis e fallback robusto por usu√°rio.
- M√≠dia: detec√ß√£o MIME inteligente, link preview ‚Äúclean‚Äù (og:image, favicon e YouTube), thumbnails de v√≠deo (ffmpeg) e PDFs (p√°ginas + miniatura).
- LID (Link ID): novos endpoints para converter Phone/JID ‚Üî LID e listar mapeamentos. Store SQL entende `@lid` e `@s.whatsapp.net` no mesmo lookup.
- Grupos/Comunidades: cria√ß√£o com `context.Context` e flags (announcement/locked/ephemeral/approval); disappearing timer com timestamp.
- Whatsmeow (fork): pareamento h√≠brido (WhatsApp Business coexistente) e Presence sem PushName no contexto Messenger.

### üîß Mudan√ßas de configura√ß√£o
- Novas vari√°veis globais
  - `GLOBAL_CALL_REJECT_MESSAGE`: mensagem padr√£o de rejei√ß√£o de chamadas.
  - `GLOBAL_CALL_REJECT_TYPE`: `busy` | `decline` | `unavailable` (default: `busy`).
  - `GLOBAL_S3_DISABLE_ACL`: `true` para buckets AWS com ‚ÄúBucket owner enforced‚Äù; `false` para provedores legados (default: `true`).
- `WA_VERSION` atualizado para `2.3000.1026436087`.
- BaseURL passa a ser calculado e cacheado (carregando `.env` automaticamente quando presente). Vari√°veis √∫teis: `ZUCKZAPGO_ADDRESS` e `ZUCKZAPGO_PORT`.

### üîå API e Eventos
- BaseURL incorporado nos eventos
  - Cabe√ßalhos adicionais nos webhooks: `X-ZuckZapGo-BaseURL` (al√©m de usu√°rio/token/jid/eventType).
  - Envelope dos eventos inclui `baseURL` e `source` (p.ex. `zuckzapgo-global`).
- Novos endpoints LID
  - `GET/POST /user/lid/get` ‚Äî Converte Phone/JID ‚Üí LID.
  - `GET/POST /user/lid/from-lid` ‚Äî Converte LID ‚Üí Phone/JID.
  - `GET /user/lid/mappings` ‚Äî Lista todos os mapeamentos LID ‚Üî Phone do usu√°rio.
- Exemplo (curl) ‚Äî obter LID a partir de JID
  ```bash
  curl -H "token: <USER_TOKEN>" \
       "https://<BASE_URL>/user/lid/get?phone=5521971532700@s.whatsapp.net"
  ```
- Exemplo (Webhook payload ‚Äî campos relevantes)
  ```json
  {
    "userToken":"***",
    "userID":"***",
    "eventType":"message",
    "userName":"Alice",
    "userJID":"55219...@s.whatsapp.net",
    "baseURL":"https://api.seudominio.com",
    "timestamp": 1725750000,
    "source": "zuckzapgo-global",
    "data": { "...": "payload do evento sem polui√ß√£o por metadados de S3" }
  }
  ```

### ‚òÅÔ∏è S3 (Global e por usu√°rio)
- Modo delivery global: `GLOBAL_S3_MEDIA_DELIVERY=base64|url|both`.
  - `url`: upload para S3 e remo√ß√£o do campo `base64` do payload.
  - `both`: upload para S3 mantendo o `base64` no payload.
- `GLOBAL_S3_DISABLE_ACL=true` (AWS moderno) evita aplicar ACL no upload; quando `false`, ACL p√∫blica √© aplicada (compatibilidade com provedores legados).
- Endpoints de S3 do usu√°rio expostos com `disable_acl` no retorno e nos testes de conex√£o.

### üìû Chamadas: rejei√ß√£o autom√°tica
- Fallback global quando usu√°rio n√£o definiu mensagem/tipo:
  - `GLOBAL_CALL_REJECT_MESSAGE` e `GLOBAL_CALL_REJECT_TYPE`.
  - Valida√ß√£o de tipo ‚Äî valores inv√°lidos caem para `busy` com aviso em log.

### üñºÔ∏è M√≠dia e Previews
- Detec√ß√£o MIME inteligente ‚Äî corrige `application/octet-stream` em √°udios/documentos.
- PTT (voice note): for√ßa `audio/ogg; codecs=opus` quando necess√°rio.
- Link preview ‚Äúclean‚Äù: coleta metadados (OpenGraph/Twitter), baixa thumbnail e envia como `MediaLinkThumbnail`. Suporte expandido para YouTube via oEmbed e scraping.
- PDF: p√°gina inicial renderizada como thumbnail (com largura/altura reais) + `pageCount` no documento.
- V√≠deo: thumbnail gerado em mem√≥ria com fallback autom√°tico para imagem padr√£o quando `ffmpeg` ausente.

### üë• Grupos/Comunidades
- `CreateGroup(context, req)` com suporte a `announcement`, `locked`, `ephemeral` e `membership_approval_mode`.
- `SetDisappearingTimer(..., settingTS)` grava timestamp de configura√ß√£o para melhor compatibilidade com o cliente.

### üîê Whatsmeow (fork privado)
- Pareamento h√≠brido (coexistente): fallback de verifica√ß√£o de assinatura com tipo de conta oposto para lidar com inconsist√™ncias de detec√ß√£o (Business/Hosted/regular).
- Presence: envia sem `PushName` quando em contexto Messenger E2EE.

### üóÉÔ∏è Migra√ß√µes de banco
- Migra√ß√£o 15 ‚Äî cache de avatar: adiciona `avatar_url` e `avatar_updated_at`.
- Migra√ß√£o 16 ‚Äî S3 sem ACL: adiciona `s3_disable_acl` (default TRUE).
- Compat√≠vel com PostgreSQL e MySQL (SQLite auxilia desenvolvimento). Aplicadas automaticamente no startup.

### üì¶ Depend√™ncias e Tooling
- Go toolchain 1.24.x, bibliotecas atualizadas (protobuf, goquery, unipdf, x/*, etc.).
- CI: matriz Go 1.24/1.25; pre-commit atualizado.
- Protobufs WhatsApp atualizados (E2E/Wa6/SyncAction/HistorySync/StatusAttributions/CompanionReg/Armadillo) e migra√ß√£o de `WAWebProtobufsBotMetadata` ‚Üí `WABotMetadata`.


## [v1.2.3] - 2025-08-15

### üöÄ Novos Recursos

#### üìö Swagger/OpenAPI Nativo

- ‚úÖ **Documenta√ß√£o Autom√°tica**: Gera√ß√£o autom√°tica de specs com UI embutida
  - Endpoint `/api/` para interface interativa
  - Artefatos em `static/api/swagger.json|yaml|docs.go`
  - Anota√ß√µes nos handlers principais
  - Metadados centralizados em `main.go`
- ‚úÖ **Domains Documentados**: Admin/Global, Session, Chat, Group, Community, Newsletter, Privacy, Business, Device, Webhook
- ‚úÖ **Sem Breaking Changes**: Compatibilidade total com APIs existentes

#### üóÑÔ∏è Suporte Completo a MySQL

- ‚úÖ **Novo Provedor MySQL**: Suporte nativo com migra√ß√µes dedicadas
  - DSN: `mysql://user:pass@host:3306/db?charset=utf8mb4&parseTime=True&loc=Local`
  - Convers√£o autom√°tica de placeholders ($1 ‚Üí ?) via `DatabaseWrapper`
  - `initialSchemaMySQLSQL` e migra√ß√µes condicionais por driver
- ‚úÖ **Compatibilidade Mantida**: SQLite e PostgreSQL continuam funcionando
- ‚úÖ **Docker Compose**: Servi√ßo MySQL opcional com tuning e healthcheck

#### üì± Novos Endpoints de Chat

- ‚úÖ **Envio de PTV**: `POST /chat/send/ptv`
  - Pre-Recorded Transfer Video por link ou base64
  - Suporte a headers de m√≠dia
  ```json
  {
    "Phone": "5511999999999",
    "Video": "https://example.com/video.mp4"
  }
  ```
- ‚úÖ **Retry de Mensagens**: `POST /chat/retry/message`
  - Reprocessamento/recupera√ß√£o de mensagens recebidas
  - Estrat√©gia: BuildUnavailableMessageRequest + envio ao pr√≥prio dispositivo
  ```json
  {
    "MessageID": "ABCD1234...",
    "ChatJID": "5511999999999@s.whatsapp.net",
    "SenderJID": "5511888888888@s.whatsapp.net",
    "RetryType": "incoming",
    "ForceRetry": true
  }
  ```

#### üåê Proxy Configur√°vel por Usu√°rio

- ‚úÖ **Endpoint de Proxy**: `POST /session/proxy`
  - Suporte a `http://`, `https://` e `socks5://`
  - Configura√ß√£o individual por usu√°rio
  - Indica√ß√£o de necessidade de reconex√£o
  ```json
  {
    "enable": true,
    "proxy_url": "socks5://user:pass@proxy.example.com:1080"
  }
  ```

#### ‚öôÔ∏è Configura√ß√µes Avan√ßadas de Dispositivo WhatsApp (Alpha)

- ‚úÖ **Configura√ß√µes Globais e por Inst√¢ncia**: Controle total sobre par√¢metros do dispositivo
  - Aplicadas ANTES da conex√£o
  - Configura√ß√µes por usu√°rio sobrep√µem globais
  - Valores inv√°lidos geram warn e usam defaults
- ‚úÖ **Enums Suportados**:
  - **waPlatform**: ANDROID, IOS, WINDOWS_PHONE, WEB, MACOS, etc.
  - **waReleaseChannel**: RELEASE, BETA, ALPHA, DEBUG
  - **waWebSubPlatform**: WEB_BROWSER, APP_STORE, WIN_STORE, DARWIN
  - **waConnectType**: WIFI_UNKNOWN, CELLULAR_LTE, CELLULAR_UMTS, etc.
  - **waPlatformType**: CHROME, FIREFOX, SAFARI, ANDROID_PHONE, IOS_PHONE, etc.
- ‚úÖ **Vari√°veis de Ambiente**:
  ```bash
  WA_VERSION=2.2413.51
  WA_PLATFORM=WEB
  WA_RELEASE_CHANNEL=RELEASE
  WA_OS_NAME=Mac OS
  WA_DEVICE_NAME=MacBook Pro
  WA_LOCALE_LANGUAGE=pt
  WA_LOCALE_COUNTRY=BR
  ```

### üõ†Ô∏è Melhorias T√©cnicas

#### üîÑ Atualiza√ß√µes do whatsmeow-private

- ‚úÖ **Compatibilidade Recente**: Recursos mais recentes do WhatsApp
- ‚úÖ **Otimiza√ß√µes de Performance**: Melhorias no core da biblioteca
- ‚úÖ **Estabilidade**: Corre√ß√µes e melhorias de conectividade

#### ‚ö° Otimiza√ß√µes de Performance

- ‚úÖ **RabbitMQ**: Configura√ß√µes globais e individuais
- ‚úÖ **Skips Configur√°veis**: Otimiza√ß√µes de processamento
- ‚úÖ **Processamento Ass√≠ncrono**: Melhor handling de mensagens

#### üèóÔ∏è Refatora√ß√£o de Tipos

- ‚úÖ **Organiza√ß√£o por Dom√≠nio**: Tipos reorganizados em `types/*`
- ‚úÖ **Remo√ß√£o de `types/index.go`**: Estrutura mais limpa
- ‚úÖ **Imports Ajustados**: Melhor organiza√ß√£o do c√≥digo
- ‚úÖ **Payloads Padronizados**: Compatibilidade com Swagger

### üì¶ Exemplos de Uso

#### Enviar PTV

```bash
curl -X POST "http://localhost:8080/chat/send/ptv" \
  -H "token: <USER_TOKEN>" -H "Content-Type: application/json" \
  -d '{
    "Phone": "5511999999999",
    "Video": "https://example.com/video.mp4"
  }'
```

#### Configurar Proxy

```bash
curl -X POST "http://localhost:8080/session/proxy" \
  -H "token: <USER_TOKEN>" -H "Content-Type: application/json" \
  -d '{
    "enable": true,
    "proxy_url": "socks5://user:pass@proxy.example.com:1080"
  }'
```

#### Retry de Mensagem

```bash
curl -X POST "http://localhost:8080/chat/retry/message" \
  -H "token: <USER_TOKEN>" -H "Content-Type: application/json" \
  -d '{
    "MessageID": "ABCD1234...",
    "ChatJID": "5511999999999@s.whatsapp.net",
    "SenderJID": "5511888888888@s.whatsapp.net",
    "RetryType": "incoming",
    "ForceRetry": true
  }'
```

### üìà Estat√≠sticas da Vers√£o

| Categoria            | Quantidade             |
| -------------------- | ---------------------- |
| **Novos Endpoints**  | 3 rotas                |
| **Banco de Dados**   | MySQL + migra√ß√µes      |
| **Documenta√ß√£o**     | Swagger nativo         |
| **Configura√ß√µes WA** | 20+ par√¢metros         |
| **Otimiza√ß√µes**      | Performance + RabbitMQ |

### üîÑ Compatibilidade

- ‚úÖ **Sem Breaking Changes**: Total compatibilidade com vers√µes anteriores
- ‚úÖ **APIs Existentes**: Todas as funcionalidades anteriores mantidas
- ‚úÖ **Bancos de Dados**: SQLite, PostgreSQL e MySQL suportados
- ‚úÖ **Configura√ß√µes**: Migra√ß√£o autom√°tica e transparente

### üîß Migra√ß√£o/Upgrade

- **Banco de Dados**: Drivers mantidos; MySQL plug√°vel; migra√ß√µes condicionadas por driver
- **Documenta√ß√£o**: Acessar `/api/` para interface Swagger
- **Dispositivo**: Vari√°veis WA\_\* opcionais; configura√ß√µes por inst√¢ncia (alpha) requerem reconex√£o
- **Proxy**: Configura√ß√£o individual por usu√°rio sem impacto em outros

### üîí Seguran√ßa e Observabilidade

- ‚úÖ **Logs Estruturados**: Melhor rastreabilidade
- ‚úÖ **M√©tricas Globais**: Estat√≠sticas expostas por endpoints Admin/Global
- ‚úÖ **Valida√ß√µes**: Mensagens claras para proxy, retry e configura√ß√µes WA inv√°lidas
- ‚úÖ **Fallbacks**: Configura√ß√µes inv√°lidas usam defaults seguros

---

## [v1.2.2] - 2025-07-27

### üöÄ Novos Recursos

#### üéØ Mensagens Interativas

- ‚úÖ **Bot√µes Interativos**: Suporte completo para mensagens com bot√µes
  - Quick reply (resposta r√°pida)
  - Copy (copiar c√≥digo/texto)
  - URL (links externos)
  - Call (liga√ß√£o)
  - PIX (pagamentos)
- ‚úÖ **Mensagens de Lista**: Suporte para single select
- ‚úÖ **Novos Endpoints**: `/chat/send/buttons`, `/chat/send/list`

#### üí¨ Gerenciamento Avan√ßado de Chat

- ‚úÖ **Pin/Unpin**: Fixar e desfixar conversas importantes
- ‚úÖ **Arquivamento**: Arquivar e desarquivar conversas
- ‚úÖ **Silenciamento**: Silenciar chats por per√≠odos (8h, 1 semana, sempre)
- ‚úÖ **Favoritos**: Marcar/desmarcar mensagens com estrela
- ‚úÖ **Sistema de Labels**: Gerenciamento completo de etiquetas
  - Editar labels existentes
  - Aplicar em chats e mensagens
  - Organiza√ß√£o inteligente

#### üîí Privacidade e Seguran√ßa

- ‚úÖ **Configura√ß√µes de Privacidade**: Controle total sobre visibilidade
- ‚úÖ **Timer de Mensagens**: Configurar mensagens tempor√°rias
- ‚úÖ **Lista de Bloqueados**: Gerenciar contatos bloqueados
- ‚úÖ **Privacidade de Status**: Controlar quem v√™ seus status
- ‚úÖ **Configura√ß√µes Avan√ßadas**: Todas as op√ß√µes de privacidade do WhatsApp

#### üë• Comunidades WhatsApp

- ‚úÖ **Cria√ß√£o de Comunidades**: Criar e gerenciar comunidades
- ‚úÖ **Vincula√ß√£o de Grupos**: Conectar grupos √†s comunidades
- ‚úÖ **An√∫ncios**: Enviar an√∫ncios para toda a comunidade
- ‚úÖ **Administra√ß√£o**: Sistema completo de modera√ß√£o
- ‚úÖ **Solicita√ß√µes**: Gerenciar pedidos de entrada

#### üíº Recursos Business

- ‚úÖ **Links Business**: Resolver links de mensagens business
- ‚úÖ **QR Code de Contato**: Gerar QR codes para contatos
- ‚úÖ **Gerenciamento de Bots**: Listar e configurar bots
- ‚úÖ **Perfis de Bots**: Informa√ß√µes detalhadas de bots
- ‚úÖ **Mensagens de Pedido**: Enviar mensagens de pedido (order message)

#### üì± Gerenciamento de Dispositivos

- ‚úÖ **Listagem de Dispositivos**: Ver todos os dispositivos conectados
- ‚úÖ **Dispositivos Vinculados**: Identificar dispositivos do usu√°rio
- ‚úÖ **Identifica√ß√£o de Plataforma**: Detectar sistema operacional
- ‚úÖ **Consultas Contextuais**: Buscas avan√ßadas com contexto

### üõ†Ô∏è Melhorias T√©cnicas

#### üîß Painel Administrativo

- ‚úÖ **Avatares de Usu√°rios**: Exibi√ß√£o de fotos de perfil
- ‚úÖ **M√©todo Interno**: `getAvatarInternal()` para busca eficiente
- ‚úÖ **Informa√ß√µes Completas**: Listagem aprimorada de usu√°rios
- ‚úÖ **Status de Conex√£o**: Indicadores visuais de conectividade

#### üìä Constantes e Valida√ß√µes

- ‚úÖ **Tipos de Eventos**: Novos eventos suportados
- ‚úÖ **Mapa de Eventos**: Valida√ß√£o r√°pida e eficiente
- ‚úÖ **Fun√ß√£o de Valida√ß√£o**: `isValidEventType()` para verifica√ß√µes

#### üîó Helpers e Utilit√°rios

- ‚úÖ **Processamento de M√≠dia**: Novos helpers para m√≠dia
- ‚úÖ **Mensagens Interativas**: Fun√ß√µes auxiliares especializadas
- ‚úÖ **Sistema de Callbacks**: Melhorias nos webhooks

#### üõ£Ô∏è Rotas e Endpoints

- ‚úÖ **35+ Novas Rotas**: Endpoints RESTful adicionados
- ‚úÖ **Organiza√ß√£o por Dom√≠nio**: Estrutura clara e l√≥gica
  - `/chat/*` - Opera√ß√µes de chat
  - `/privacy/*` - Configura√ß√µes de privacidade
  - `/community/*` - Gerenciamento de comunidades
  - `/business/*` - Recursos business
  - `/device/*` - Gerenciamento de dispositivos

#### üì§ Handlers de Envio

- ‚úÖ **SendButtonsMessage()**: Implementa√ß√£o completa
- ‚úÖ **SendListMessage()**: Suporte total para listas
- ‚úÖ **SendCarouselMessage()**: Mensagens em carrossel
- ‚úÖ **Valida√ß√µes Robustas**: Tratamento de erros aprimorado

### üì¶ Novos Servi√ßos

#### üè≠ Factory de Mensagens

- ‚úÖ **create_buttons_message_service.go**

  - Factory pattern para cria√ß√£o de bot√µes
  - Suporte para 6 tipos diferentes
  - Valida√ß√µes de limites e formatos
  - Suporte para m√≠dia no header

- ‚úÖ **create_list_message_service.go**
  - Factory para mensagens de lista
  - M√∫ltiplas se√ß√µes suportadas
  - Valida√ß√µes de tamanho e conte√∫do

### üìà Estat√≠sticas da Vers√£o

| Categoria             | Quantidade   |
| --------------------- | ------------ |
| **Novos Handlers**    | 9 arquivos   |
| **Novos Endpoints**   | 35+ rotas    |
| **Novos Servi√ßos**    | 3 servi√ßos   |
| **Novas Fun√ß√µes**     | 100+ fun√ß√µes |
| **Recursos WhatsApp** | Completo     |

### üîÑ Compatibilidade

- ‚úÖ **Sem Breaking Changes**: Total compatibilidade com vers√µes anteriores
- ‚úÖ **APIs Existentes**: Todas as funcionalidades anteriores mantidas
- ‚úÖ **Configura√ß√µes**: Compatibilidade total com configura√ß√µes existentes

### üìö Documenta√ß√£o

- ‚úÖ **CHANGELOG.md**: Atualizado com todas as mudan√ßas
- ‚úÖ **Dockerfile**: Melhorias na imagem Docker
- ‚úÖ **docker-compose**: Configura√ß√µes atualizadas
- ‚úÖ **API Spec**: Documenta√ß√£o da API atualizada
- ‚úÖ **Postman**: Cole√ß√£o atualizada
- ‚úÖ **Dashboard**: Interface HTML melhorada

## üìä Estat√≠sticas

- **Total de commits**: 64
- **Per√≠odo**: 2025-06-11 at√© 2025-07-13

### üë• Principais Contribuidores

- **Guilherme Jansen**: 52 commit(s)
- **GitHub Action**: 10 commit(s)
- **GitHub Actions Bot**: 2 commit(s)

### üîó Links √öteis

- [üöÄ GitHub Repository](https://github.com/guilhermejansen/use-zuckzapgo)
- [üê≥ Docker Hub](https://hub.docker.com/r/setupautomatizado/zuckzapgo-private)
- [üìñ Documenta√ß√£o](https://github.com/guilhermejansen/use-zuckzapgo/blob/main/README.md)
- [üÜò Suporte](mailto:contato@setupautomatizado.com.br)
